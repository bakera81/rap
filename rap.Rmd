---
title: "Rap Lyric Sentiment Analysis"
author: "Anthony Baker"
date: "5/7/2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(jsonlite)
library(DBI)
library(yaml)
library(tidytext)
library(lubridate)
```

```{r}
# Read from the DB
creds = read_yaml("db/genius_db.yml")
con <- dbConnect(RMariaDB::MariaDB(), 
                 username = creds$username,
                 password = creds$password,
                 host = creds$host,
                 dbname = creds$database)
dbListTables(con)

res <- dbSendQuery(con, "SELECT * FROM songs_v3")

songs <- dbFetch(res)
dbClearResult(res)
```

```{r}
# Inspect
future <- songs

# How many songs?
future %>%
  nrow()

# How many of the songs are Future's?
future %>% 
  filter(primary_artist_id == 2197) %>%
  nrow()

future %>% 
  pull(song_id) %>%
  anyDuplicated()

future %>% 
  count(lyrics_language, sort = T)

future %>% 
  count(published, sort = T)

```


```{r}
# Look at lyrics by line
future_lyrics <- future %>%
  select(song_id, primary_artist_id, title, url, release_date, lyrics) %>%
  mutate(release_Date = as.Date(release_date),
         lyrics = str_replace(lyrics, '^\\[', ''), # Remove opening bracket in list
         lyrics = str_replace(lyrics, '\\]$', ''), # Remove closing bracket in list
         lyrics = str_replace_all(lyrics, '"', ''), # Remove quotes
         lyrics = str_split(lyrics, ', ')) %>% # TODO: This splits lines if they contain a comma
  unnest(lyrics) %>%
  filter(lyrics != '') %>% # Don't include newlines
  # Create a verse artist column to distinguish who is rapping
  mutate(verse_artist = ifelse(str_detect(lyrics, '^\\[.*\\]$'), # Look for [Verse n: Artist]
                               lyrics,
                               NA),
         verse_artist = str_replace_all(verse_artist, '(^+*: )|(\\])', '')) %>% # Isolate the artist name
  # Expand verse_artist for all relevant rows 
  fill(verse_artist) %>%
  # Exclude the verse signifiers
  filter(!str_detect(lyrics, '^\\[.*\\]$'))

future_lyrics %>% 
  distinct(song_id, verse_artist) %>%
  count(verse_artist, sort = T)
```

```{r}
# DEBUGGING: need better parsing for verse artist
test <- songs %>%
  filter(song_id == 3536550) 

test %>% 
  select(song_id, primary_artist_id, title, url, release_date, lyrics) %>%
  mutate(release_Date = as.Date(release_date),
         lyrics = str_replace(lyrics, '^\\[', ''), # Remove opening bracket in list
         lyrics = str_replace(lyrics, '\\]$', ''), # Remove closing bracket in list
         lyrics = str_replace_all(lyrics, '"', ''), # Remove quotes
         lyrics = str_split(lyrics, ', ')) %>% # TODO: This splits lines if they contain a comma
  unnest(lyrics) %>%
  filter(lyrics != '') %>% # Don't include newlines
  # Create a verse artist column to distinguish who is rapping
  mutate(verse_artist = ifelse(str_detect(lyrics, '^\\[.*\\]$'), # Look for [Verse n: Artist]
                               lyrics,
                               NA),
         # TODO: Make sure the verse artist contains :
         verse_artist = ifelse(str_detect(lyrics, ': '),
                               str_replace_all(verse_artist, '(^.*: )|(\\])', ''),
                               NA)) %>% # Isolate the artist name
  # Expand verse_artist for all relevant rows 
  fill(verse_artist) %>%
  View()

# TODO: set verse_artist to NA if the artist isn't specified in the verse
```


```{r}
# Look at lyrics by word
data(stop_words)

future_words <- future_lyrics %>% 
  unnest_tokens(word, lyrics) %>%
  anti_join(stop_words, by = "word")



future_words %>%
  count(word, sort = T) %>%
  View()

future_words %>%
  filter(!is.na(month)) %>%
  count(month = floor_date(release_date, "month")) %>%
  ungroup() %>%
  ggplot(aes(month, n, color = word)) + 
  geom_line()

```

```{r}
# TODO: user the [Verse n: artist] tags to separate the verses
```

```{r}
songs %>%
  # TODO: Are lyric lines being split properly?
  mutate(lyrics = str_replace(lyrics, '^\\[', ''),
         lyrics = str_replace(lyrics, '\\]$', ''),
         # lyrics = str_replace_all(lyrics, '"', ''),
         lyrics = str_split(lyrics, '", "')) %>%
  unnest(lyrics) %>%
  View()
```

### Questions
0. Most frequent collaborators?
0A. Most frequent producers?
1. All time, most frequent words?
1A. Most frequent words over time?
1B. Most frequent words on his own songs vs guest verses?
2. Range of vocab?
3. Sentiment
4. Favorite drug?